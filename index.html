<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Edge Book</title>
  <style>
    body { font-family: Arial, sans-serif; background:#111; color:#eee; }
    .hidden { display:none; }
    button:disabled { opacity:0.5; pointer-events:none; }
    .admin-panel { margin-top:20px; padding:10px; border:1px solid #444; }
    .leaderboard, .history { margin-top:20px; }
  </style>
</head>
<body>
  <h1>Edge Book</h1>

  <!-- Login -->
  <div id="login">
    <input id="username" placeholder="Enter username">
    <button id="loginBtn">Login</button>
  </div>

  <!-- User Panel -->
  <div id="userPanel" class="hidden">
    <h2 id="welcome"></h2>
    <p>Available Coins: <span id="coins">0</span></p>
    <div id="bettingArea" class="hidden">
      <h3>Place Bets</h3>
      <select id="playerSelect"></select>
      <select id="propSelect">
        <option value="Goal">Goal</option>
        <option value="Assist">Assist</option>
        <option value="Clean Sheet">Clean Sheet</option>
      </select>
      <input id="betAmount" type="number" min="1" value="1">
      <button id="placeBet">Submit Bet</button>
      <div id="currentBets"></div>
    </div>

    <div id="mvpVoting" class="hidden">
      <h3>MVP Voting</h3>
      1st: <select id="vote1"></select>
      2nd: <select id="vote2"></select>
      3rd: <select id="vote3"></select>
      <button id="submit-votes">Submit Votes</button>
    </div>

    <div class="leaderboard">
      <h3>Leaderboard</h3>
      <ul id="leaderboardList"></ul>
      <h3>MVP Leaderboard</h3>
      <ul id="mvpLeaderboardList"></ul>
    </div>

    <div class="history">
      <h3>Betting History</h3>
      <ul id="historyList"></ul>
    </div>
  </div>

  <!-- Admin Panel -->
  <div id="adminPanel" class="admin-panel hidden">
    <h2>Admin Controls</h2>
    <button id="open-bets">Open Bets</button>
    <button id="close-bets" disabled>Close Bets</button>
    <button id="start-match" disabled>Start Match</button>
    <button id="end-match" disabled>End Match</button>
  </div>

<script>
let users = JSON.parse(localStorage.getItem("users")) || {};
let currentUser=null;
let matchActive=false;

function saveUsers(){ localStorage.setItem("users", JSON.stringify(users)); }

function updateLeaderboards(){
  let lb=document.getElementById("leaderboardList");
  lb.innerHTML="";
  Object.keys(users).forEach(u=>{
    if(!users[u].isAdmin){
      let li=document.createElement("li");
      li.textContent=`${u}: ${users[u].totalCoins} coins`;
      lb.appendChild(li);
    }
  });
  let mvp=document.getElementById("mvpLeaderboardList");
  mvp.innerHTML="";
  Object.keys(users).forEach(u=>{
    if(!users[u].isAdmin){
      let li=document.createElement("li");
      li.textContent=`${u}: ${users[u].mvpPoints} MVP pts`;
      mvp.appendChild(li);
    }
  });
}

function updateHistory(){
  let list=document.getElementById("historyList");
  list.innerHTML="";
  if(!currentUser) return;
  users[currentUser].history.forEach(h=>{
    let li=document.createElement("li");
    li.textContent=`${h.match}: ${h.bets.map(b=>`${b.player}-${b.prop}-${b.amount}c ${b.won?'W':'L'}`).join(", ")}`;
    list.appendChild(li);
  });
}

function populatePlayers(select){
  select.innerHTML="";
  Object.keys(users).forEach(u=>{
    if(!users[u].isAdmin){
      let opt=document.createElement("option");
      opt.value=u; opt.textContent=u;
      select.appendChild(opt);
    }
  });
}

document.getElementById("loginBtn").addEventListener("click",()=>{
  let uname=document.getElementById("username").value.trim();
  if(!uname) return;
  if(!users[uname]){
    users[uname]={isAdmin:(uname==="Erick"),availableCoins:0,totalCoins:0,bets:[],history:[],votes:{},mvpPoints:0};
  }
  currentUser=uname;
  saveUsers();
  document.getElementById("login").classList.add("hidden");
  document.getElementById("userPanel").classList.remove("hidden");
  document.getElementById("welcome").textContent=`Welcome ${uname}`;
  document.getElementById("coins").textContent=users[uname].availableCoins;
  populatePlayers(document.getElementById("playerSelect"));
  populatePlayers(document.getElementById("vote1"));
  populatePlayers(document.getElementById("vote2"));
  populatePlayers(document.getElementById("vote3"));
  updateLeaderboards();
  updateHistory();
  if(users[uname].isAdmin){
    document.getElementById("adminPanel").classList.remove("hidden");
  }
});

// Place Bet
document.getElementById("placeBet").addEventListener("click",()=>{
  let amt=parseInt(document.getElementById("betAmount").value);
  if(amt>users[currentUser].availableCoins){alert("Not enough coins");return;}
  let player=document.getElementById("playerSelect").value;
  let prop=document.getElementById("propSelect").value;
  users[currentUser].availableCoins-=amt;
  users[currentUser].bets.push({player,prop,amount:amt,odds:2,resolved:false});
  document.getElementById("coins").textContent=users[currentUser].availableCoins;
  saveUsers();
});

// MVP Submit Votes (fixed)
document.getElementById('submit-votes').addEventListener('click', ()=>{
  if(!matchActive){ alert("Match not started yet."); return; }
  let first=document.getElementById('vote1').value;
  let second=document.getElementById('vote2').value;
  let third=document.getElementById('vote3').value;
  if(new Set([first,second,third]).size < 3){ alert("Cannot vote same player multiple times."); return; }
  users[currentUser].votes = {"1st":first,"2nd":second,"3rd":third};
  saveUsers();
  alert("Votes submitted!");
  updateLeaderboards();
});

// Admin Buttons
let openBtn=document.getElementById("open-bets");
let closeBtn=document.getElementById("close-bets");
let startBtn=document.getElementById("start-match");
let endBtn=document.getElementById("end-match");

openBtn.addEventListener("click",()=>{
  Object.keys(users).forEach(u=>{
    if(!users[u].isAdmin) users[u].availableCoins+=10;
  });
  saveUsers();
  if(!users[currentUser].isAdmin){
    document.getElementById("coins").textContent=users[currentUser].availableCoins;
  }
  document.getElementById("bettingArea").classList.remove("hidden");
  openBtn.disabled=true; closeBtn.disabled=false;
});

closeBtn.addEventListener("click",()=>{
  document.getElementById("bettingArea").classList.add("hidden");
  Object.keys(users).forEach(u=>{users[u].availableCoins=0;});
  saveUsers();
  closeBtn.disabled=true; startBtn.disabled=false;
});

startBtn.addEventListener("click",()=>{
  matchActive=true;
  document.getElementById("mvpVoting").classList.remove("hidden");
  ["vote1","vote2","vote3"].forEach(id=>document.getElementById(id).disabled=false);
  document.getElementById("submit-votes").disabled=false;
  startBtn.disabled=true; endBtn.disabled=false;
});

// End Match (fixed)
endBtn.addEventListener('click', ()=>{
  if(!currentUser || !users[currentUser].isAdmin){ alert("Only admin"); return; }
  
  Object.keys(users).forEach(u=>{
    if(!users[u].isAdmin){
      users[u].bets.forEach(b=>{
        if(!b.resolved){
          let res=confirm(`Did ${b.player} succeed in ${b.prop}? (OK=Win, Cancel=Lose)`);
          b.won=res;
          if(res) users[u].totalCoins+=b.amount*b.odds;
          b.resolved=true;
        }
      });
      users[u].availableCoins=0;
      if(users[u].bets.length>0){
        users[u].history.push({match:`Match ${users[u].history.length+1}`,bets:[...users[u].bets]});
        users[u].bets=[];
      }
    }
  });

  Object.keys(users).forEach(u=>{
    if(!users[u].isAdmin){
      let v=users[u].votes;
      if(v["1st"]) users[v["1st"]].mvpPoints+=5;
      if(v["2nd"]) users[v["2nd"]].mvpPoints+=3;
      if(v["3rd"]) users[v["3rd"]].mvpPoints+=2;
      users[u].votes={};
    }
  });

  ["vote1","vote2","vote3"].forEach(id=>document.getElementById(id).disabled=true);
  document.getElementById('submit-votes').disabled=true;

  saveUsers();
  updateLeaderboards();
  updateHistory();
  alert("Match ended! Bets resolved and MVP points tallied.");

  // Reset button sequence
  openBtn.disabled=false;
  closeBtn.disabled=true;
  startBtn.disabled=true;
  endBtn.disabled=true;

  matchActive=false;
});
</script>
</body>
</html>
